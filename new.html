<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Firebase Episode Sync</title>
<style>
  body { font-family: sans-serif; background: #121212; color: #fff; text-align: center; }
  #log { text-align: left; background: #1e1e1e; padding: 1rem; border-radius: 8px; margin: 1rem; height: 300px; overflow-y: auto; }
</style>
</head>
<body>
<h2>🔥 رفع الحلقات إلى Firebase Firestore</h2>
<div id="log"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>

<script>
const logBox = document.getElementById("log");
function log(msg) {
  console.log(msg);
  logBox.innerHTML += msg + "<br>";
}

// 🔧 إعدادات Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAQpXUUOLyN2B6IWGb5Ru2Dl8NZPNimTEg",
  authDomain: "wep1-25124.firebaseapp.com",
  databaseURL: "https://wep1-25124-default-rtdb.firebaseio.com",
  projectId: "wep1-25124",
  storageBucket: "wep1-25124.firebasestorage.app",
  messagingSenderId: "400763524699",
  appId: "1:400763524699:web:b3d5b77815de059ad9117e",
  measurementId: "G-ER2GCC7BK4"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ⚙️ الدالة الرئيسية
(async function startUpload() {
  log("📡 جاري جلب بيانات الجديد.json ...");

  try {
    const response = await fetch("الجديد.json");
    const data = await response.json();
    const animeLinks = data.animes;

    log(`✅ تم العثور على ${animeLinks.length} روابط أنمي.`);

    const fetchedEpisodes = [];
    let index = 1;

    // جلب كل أنمي بالتتابع
    for (const url of animeLinks) {
      try {
        const res = await fetch(url);
        const animeData = await res.json();
        animeData.episodes.forEach(ep => {
          fetchedEpisodes.push({
            animeTitle: animeData.animeTitle,
            image: ep.image,
            link: ep.link,
            number: ep.number,
            title: ep.title,
            date: ep.date || new Date().toISOString()
          });
        });
        log(`🎬 (${index}/${animeLinks.length}) تم تحميل ${animeData.episodes.length} حلقة من ${animeData.animeTitle}`);
      } catch (err) {
        log(`❌ خطأ في جلب ${url}: ${err}`);
      }
      index++;
    }

    // ترتيب الحلقات حسب التاريخ
    fetchedEpisodes.sort((a, b) => new Date(b.date) - new Date(a.date));

    log(`📦 تم جمع ${fetchedEpisodes.length} حلقة. جاري رفعها إلى Firestore...`);
    await uploadEpisodesToFirestore(fetchedEpisodes);

  } catch (err) {
    log("❌ خطأ رئيسي: " + err);
  }
})();

// 🧩 تقسيم ورفع الأجزاء إلى Firestore
async function uploadEpisodesToFirestore(fetchedEpisodes) {
  const chunkSize = 500; // كل 500 حلقة في Document
  const chunks = [];
  for (let i = 0; i < fetchedEpisodes.length; i += chunkSize) {
    chunks.push(fetchedEpisodes.slice(i, i + chunkSize));
  }

  log(`🔹 تقسيم ${fetchedEpisodes.length} حلقة إلى ${chunks.length} جزء.`);

  const collectionRef = db.collection("episodes");

  // حذف القديم
  const snapshot = await collectionRef.get();
  const batchDelete = db.batch();
  snapshot.forEach(doc => batchDelete.delete(doc.ref));
  await batchDelete.commit();
  log("🧹 تم حذف البيانات القديمة من Firestore.");

  // رفع الأجزاء
  for (let i = 0; i < chunks.length; i++) {
    const partRef = collectionRef.doc(`part${i + 1}`);
    await partRef.set({
      episodes: chunks[i],
      updatedAt: Date.now()
    });
    log(`✅ تم رفع part${i + 1} (${chunks[i].length} حلقة)`);
  }

  // رفع معلومات عامة
  await collectionRef.doc("meta").set({
    total: fetchedEpisodes.length,
    parts: chunks.length,
    updatedAt: Date.now()
  });

  log("🔥 تم رفع كل الأجزاء بنجاح إلى Firestore!");
}
</script>
</body>
</html>
