<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>الحلقات الجديدة</title>
<link rel="stylesheet" href="/CSS/style.css" />

<style>
/* شكل الكارد */
.anime-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 15px;
}

.anime-card {
  background: #181818;
  border-radius: 1rem;
  overflow: hidden;
  transition: transform .2s ease;
}

.anime-card:hover {
  transform: translateY(-5px);
}

.anime-image {
  position: relative;
  overflow: hidden;
  border-radius: 1rem 1rem 0 0;
}

.anime-image img {
  width: 100%;
  height: 16rem;
  object-fit: cover;
  transition: transform 0.4s ease;
  opacity: 0;
}

.anime-image img.loaded {
  opacity: 1;
}

.anime-card:hover .anime-image img {
  transform: scale(1.1);
}

/* معلومات الأنمي */
.anime-info {
  padding: 10px;
}

.anime-info h3 {
  font-size: 1rem;
  margin: 0 0 6px;
}

.anime-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.watch-button {
  background: #e43030;
  color: white;
  padding: 4px 8px;
  border-radius: 6px;
  text-decoration: none;
}

/* شاشة تحميل */
.loading-overlay {
  position: fixed; top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,.7);
  display: flex; flex-direction: column;
  justify-content: center; align-items: center;
  z-index: 999; color: white;
  font-size: 1.2em;
}

.spinner {
  width: 40px; height: 40px;
  border: 4px solid rgba(255,255,255,0.3);
  border-top: 4px solid white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 15px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
</head>

<body>

<main>
  <div class="section-header">
    <h1>أحدث الحلقات</h1>
  </div>

  <div class="anime-grid" id="animeGridNew"></div>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <span>جاري تحميل الأنمي...</span>
  </div>
</main>

<script>
/* =======================
   lazy loading للصور
========================== */
function setupLazyLoading() {
  const images = document.querySelectorAll("img[data-src]");
  const observer = new IntersectionObserver((entries, obs) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target;
        img.src = img.dataset.src;
        img.onload = () => img.classList.add("loaded");
        img.removeAttribute("data-src");
        obs.unobserve(img);
      }
    });
  }, { rootMargin: "100px" });

  images.forEach(img => observer.observe(img));
}

/* ============================
   تحميل آخر 5 حلقات فقط
=============================== */
async function loadEpisodes() {
  try {
    const response = await fetch("الجديد.json");
    const data = await response.json();

    if (!Array.isArray(data)) {
      console.error("الجديد.json يجب أن يكون عبارة عن List");
      return;
    }

    // آخر 5 حلقات من آخر الملف
    const lastFive = data.slice(-5).reverse();

    renderEpisodes(lastFive);

  } catch (e) {
    console.error("خطأ في قراءة الجديد.json:", e);
  }

  document.getElementById("loadingOverlay").style.display = "none";
}

function renderEpisodes(list) {
  const grid = document.getElementById("animeGridNew");
  grid.innerHTML = "";

  list.forEach(ep => {
    const card = document.createElement("div");
    card.className = "anime-card";

    card.innerHTML = `
      <div class="anime-image">
        <img data-src="${ep.image}" alt="${ep.animeTitle}">
      </div>
      <div class="anime-info">
        <h3>${ep.animeTitle}</h3>
        <div class="anime-meta">
          <span>${ep.title}</span>
          <a href="${ep.link}" class="watch-button" target="_blank">شاهد الآن</a>
        </div>
      </div>
    `;

    grid.appendChild(card);
  });

  setupLazyLoading();
}

loadEpisodes();
</script>

</body>
</html>
