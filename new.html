<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Firebase Episode Sync</title>
<style>
  body { font-family: sans-serif; background: #121212; color: #fff; text-align: center; }
  #log { text-align: left; background: #1e1e1e; padding: 1rem; border-radius: 8px; margin: 1rem; height: 300px; overflow-y: auto; }
</style>
</head>
<body>
<h2>ğŸ”¥ Ø±ÙØ¹ Ø§Ù„Ø­Ù„Ù‚Ø§Øª Ø¥Ù„Ù‰ Firebase Firestore</h2>
<div id="log"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>

<script>
const logBox = document.getElementById("log");
function log(msg) {
  console.log(msg);
  logBox.innerHTML += msg + "<br>";
}

// ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAQpXUUOLyN2B6IWGb5Ru2Dl8NZPNimTEg",
  authDomain: "wep1-25124.firebaseapp.com",
  databaseURL: "https://wep1-25124-default-rtdb.firebaseio.com",
  projectId: "wep1-25124",
  storageBucket: "wep1-25124.firebasestorage.app",
  messagingSenderId: "400763524699",
  appId: "1:400763524699:web:b3d5b77815de059ad9117e",
  measurementId: "G-ER2GCC7BK4"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// âš™ï¸ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
(async function startUpload() {
  log("ğŸ“¡ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯.json ...");

  try {
    const response = await fetch("Ø§Ù„Ø¬Ø¯ÙŠØ¯.json");
    const data = await response.json();
    const animeLinks = data.animes;

    log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${animeLinks.length} Ø±ÙˆØ§Ø¨Ø· Ø£Ù†Ù…ÙŠ.`);

    const fetchedEpisodes = [];
    let index = 1;

    // Ø¬Ù„Ø¨ ÙƒÙ„ Ø£Ù†Ù…ÙŠ Ø¨Ø§Ù„ØªØªØ§Ø¨Ø¹
    for (const url of animeLinks) {
      try {
        const res = await fetch(url);
        const animeData = await res.json();
        animeData.episodes.forEach(ep => {
          fetchedEpisodes.push({
            animeTitle: animeData.animeTitle,
            image: ep.image,
            link: ep.link,
            number: ep.number,
            title: ep.title,
            date: ep.date || new Date().toISOString()
          });
        });
        log(`ğŸ¬ (${index}/${animeLinks.length}) ØªÙ… ØªØ­Ù…ÙŠÙ„ ${animeData.episodes.length} Ø­Ù„Ù‚Ø© Ù…Ù† ${animeData.animeTitle}`);
      } catch (err) {
        log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ ${url}: ${err}`);
      }
      index++;
    }

    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ù„Ù‚Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
    fetchedEpisodes.sort((a, b) => new Date(b.date) - new Date(a.date));

    log(`ğŸ“¦ ØªÙ… Ø¬Ù…Ø¹ ${fetchedEpisodes.length} Ø­Ù„Ù‚Ø©. Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹Ù‡Ø§ Ø¥Ù„Ù‰ Firestore...`);
    await uploadEpisodesToFirestore(fetchedEpisodes);

  } catch (err) {
    log("âŒ Ø®Ø·Ø£ Ø±Ø¦ÙŠØ³ÙŠ: " + err);
  }
})();

// ğŸ§© ØªÙ‚Ø³ÙŠÙ… ÙˆØ±ÙØ¹ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø¥Ù„Ù‰ Firestore
async function uploadEpisodesToFirestore(fetchedEpisodes) {
  const chunkSize = 500; // ÙƒÙ„ 500 Ø­Ù„Ù‚Ø© ÙÙŠ Document
  const chunks = [];
  for (let i = 0; i < fetchedEpisodes.length; i += chunkSize) {
    chunks.push(fetchedEpisodes.slice(i, i + chunkSize));
  }

  log(`ğŸ”¹ ØªÙ‚Ø³ÙŠÙ… ${fetchedEpisodes.length} Ø­Ù„Ù‚Ø© Ø¥Ù„Ù‰ ${chunks.length} Ø¬Ø²Ø¡.`);

  const collectionRef = db.collection("episodes");

  // Ø­Ø°Ù Ø§Ù„Ù‚Ø¯ÙŠÙ…
  const snapshot = await collectionRef.get();
  const batchDelete = db.batch();
  snapshot.forEach(doc => batchDelete.delete(doc.ref));
  await batchDelete.commit();
  log("ğŸ§¹ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù…Ù† Firestore.");

  // Ø±ÙØ¹ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡
  for (let i = 0; i < chunks.length; i++) {
    const partRef = collectionRef.doc(`part${i + 1}`);
    await partRef.set({
      episodes: chunks[i],
      updatedAt: Date.now()
    });
    log(`âœ… ØªÙ… Ø±ÙØ¹ part${i + 1} (${chunks[i].length} Ø­Ù„Ù‚Ø©)`);
  }

  // Ø±ÙØ¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø©
  await collectionRef.doc("meta").set({
    total: fetchedEpisodes.length,
    parts: chunks.length,
    updatedAt: Date.now()
  });

  log("ğŸ”¥ ØªÙ… Ø±ÙØ¹ ÙƒÙ„ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Firestore!");
}
</script>
</body>
</html>
