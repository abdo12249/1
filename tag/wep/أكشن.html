<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>تصنيفات الأنمي</title>
  <link rel="stylesheet" href="../../CSS/style.css" />
  <script src="../../navbar.js" defer></script>
  <link rel="icon" href="https://abdo12249.github.io/1/navbar/favicon.ico" type="image/x-icon" />
</head>
<body>
  <div id="navbar-container"></div>

  <main>
    <div class="section-header">
      <h1>تصنيفات الأنمي</h1>
    </div>

    <!-- فلاتر Dropdown -->
    <div id="filters" style="text-align: center; margin: 20px;">
      <label><strong>التصنيف:</strong>
        <select id="categorySelect" class="watch-button" onchange="applyFilters()">
          <option value="all">عرض الكل</option>
        </select>
      </label>

      <label><strong>النوع:</strong>
        <select id="typeSelect" class="watch-button" onchange="applyFilters()">
          <option value="all">الكل</option>
        </select>
      </label>

      <label><strong>الحالة:</strong>
        <select id="statusSelect" class="watch-button" onchange="applyFilters()">
          <option value="all">الكل</option>
        </select>
      </label>

      <label><strong>الموسم:</strong>
        <select id="seasonSelect" class="watch-button" onchange="applyFilters()">
          <option value="all">الكل</option>
        </select>
      </label>
    </div>

    <div class="anime-grid" id="animeGrid"></div>
    <div id="pagination" style="text-align: center; margin-top: 20px;"></div>
  </main>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    let currentPage = parseInt(urlParams.get("page")) || 1;
    const itemsPerPage = 30;
    let allAnimes = [];
    let originalAnimes = [];

    function updatePageInURL(page) {
      const url = new URL(window.location);
      url.searchParams.set("page", page);
      window.history.pushState({}, "", url);
    }

    async function loadAnimeData() {
      try {
        const response = await fetch("https://abdo12249.github.io/1/test1/animes.json");
        if (!response.ok) throw new Error("❌ فشل تحميل animes.json");

        const data = await response.json();
        const animeList = Object.entries(data).map(([id, anime]) => ({ id, ...anime }));
        allAnimes = animeList;
        originalAnimes = animeList;

        generateFilterOptions();
        applyFilters();
      } catch (error) {
        console.error("❌ خطأ في تحميل الأنميات:", error);
      }
    }

    function adjustPath(path) {
      return path.startsWith('../') ? path.replace('../', '../../') : path;
    }

    function displayAnime(anime) {
      const card = document.createElement('div');
      card.className = 'anime-card';
      const categories = anime.tags || anime.categories || [];
      card.setAttribute('data-categories', categories.join(','));

      const link = `../../test1/Anime Page Dynamic.html?id=${anime.id}`;

      card.innerHTML = `
        <a href="${link}" style="text-decoration: none; color: inherit;">
          <div class="anime-image">
            <img data-src="${adjustPath(anime.image)}" alt="${anime.title}" class="lazy-img" />
          </div>
          <div class="anime-info">
            <h3>${anime.title}</h3>
            <p>${anime.description || ''}</p>
            <div class="anime-meta">
              <span><strong>التصنيفات:</strong> ${categories.join(', ')}</span>
              <span><strong>النوع:</strong> ${anime.type || 'غير معروف'}</span>
              <span><strong>الموسم:</strong> ${anime.season || 'غير متوفر'}</span>
              <span><strong>المدة:</strong> ${anime.duration || 'غير معروفة'}</span>
              <span><strong>الحالة:</strong> ${anime.status || 'غير معروف'}</span>
              <span class="watch-button">شاهد الآن</span>
            </div>
          </div>
        </a>
      `;
      return card;
    }

    function showPage(page) {
      const animeGrid = document.getElementById('animeGrid');
      animeGrid.innerHTML = "";

      const startIndex = (page - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const currentItems = allAnimes.slice(startIndex, endIndex);

      currentItems.forEach(anime => {
        const card = displayAnime(anime);
        animeGrid.appendChild(card);
      });

      lazyLoadImages();
    }

    function createPagination() {
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = "";

      const totalPages = Math.ceil(allAnimes.length / itemsPerPage);

      if (currentPage > 1) {
        const prevBtn = document.createElement('button');
        prevBtn.textContent = "السابق";
        prevBtn.className = "watch-button";
        prevBtn.onclick = () => {
          currentPage--;
          updatePageInURL(currentPage);
          showPage(currentPage);
          createPagination();
        };
        pagination.appendChild(prevBtn);
      }

      for (let i = 1; i <= totalPages; i++) {
        const button = document.createElement('button');
        button.textContent = i;
        button.className = "watch-button";
        if (i === currentPage) button.classList.add("active");

        button.addEventListener('click', () => {
          currentPage = i;
          updatePageInURL(currentPage);
          showPage(currentPage);
          createPagination();
        });

        pagination.appendChild(button);
      }

      if (currentPage < totalPages) {
        const nextBtn = document.createElement('button');
        nextBtn.textContent = "التالي";
        nextBtn.className = "watch-button";
        nextBtn.onclick = () => {
          currentPage++;
          updatePageInURL(currentPage);
          showPage(currentPage);
          createPagination();
        };
        pagination.appendChild(nextBtn);
      }
    }

    function generateFilterOptions() {
      const categorySet = new Set();
      const typeSet = new Set();
      const statusSet = new Set();
      const seasonMap = new Map();

      originalAnimes.forEach(anime => {
        (anime.tags || anime.categories || []).forEach(tag => categorySet.add(tag));
        if (anime.type) typeSet.add(anime.type);
        if (anime.status) statusSet.add(anime.status);
        if (anime.season) seasonMap.set(anime.season.trim(), true);
      });

      // ترتيب المواسم حسب التاريخ والموسم
      const seasonOrder = { "شتاء": 1, "ربيع": 2, "صيف": 3, "خريف": 4 };
      const sortedSeasons = [...seasonMap.keys()]
        .map(season => {
          const parts = season.split(" ");
          const name = parts[0];
          const year = parseInt(parts[1]);
          const order = seasonOrder[name] || 99;
          return { season, year, order };
        })
        .sort((a, b) => {
          if (a.year !== b.year) return a.year - b.year;
          return a.order - b.order;
        })
        .map(item => item.season);

      fillSelect("categorySelect", categorySet);
      fillSelect("typeSelect", typeSet);
      fillSelect("statusSelect", statusSet);
      fillSelect("seasonSelect", sortedSeasons);
    }

    function fillSelect(id, values) {
      const select = document.getElementById(id);
      values.forEach(value => {
        const option = document.createElement("option");
        option.value = value;
        option.textContent = value;
        select.appendChild(option);
      });
    }

    function applyFilters() {
      const selectedCategory = document.getElementById("categorySelect").value;
      const selectedType = document.getElementById("typeSelect").value;
      const selectedStatus = document.getElementById("statusSelect").value;
      const selectedSeason = document.getElementById("seasonSelect").value;

      allAnimes = originalAnimes.filter(anime => {
        const tags = anime.tags || anime.categories || [];
        const categoryMatch = selectedCategory === "all" || tags.includes(selectedCategory);
        const typeMatch = selectedType === "all" || anime.type === selectedType;
        const statusMatch = selectedStatus === "all" || anime.status === selectedStatus;
        const seasonMatch = selectedSeason === "all" || anime.season === selectedSeason;

        return categoryMatch && typeMatch && statusMatch && seasonMatch;
      });

      currentPage = 1;
      updatePageInURL(currentPage);
      showPage(currentPage);
      createPagination();
    }

    function lazyLoadImages() {
      const images = document.querySelectorAll('.lazy-img');
      const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const img = entry.target;
            img.src = img.getAttribute('data-src');
            img.removeAttribute('data-src');
            observer.unobserve(img);
          }
        });
      }, {
        rootMargin: '0px 0px 50px 0px',
        threshold: 0.1
      });

      images.forEach(img => {
        observer.observe(img);
      });
    }

    loadAnimeData();
  </script>

  <script>
    fetch('../../navbar.html')
      .then(response => response.text())
      .then(data => document.getElementById('navbar-container').innerHTML = data)
      .catch(error => console.error('❌ خطأ في تحميل الشريط العلوي:', error));
  </script>
</body>
</html>
