<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø­Ù„Ù‚Ø©</title>
  <meta name="description" content="Ø¹Ø±Ø¶ Ø£Ù†Ù…ÙŠ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ" id="meta-description">
  <link rel="stylesheet" href="../CSS/episodes.css">
  <link rel="stylesheet" href="../CSS/style.css">
  <script type="module" src="../RS.js"></script>
  <script type="module" src="../navbar.js"></script>
  <link rel="icon" href="https://abdo838.github.io/1/navbar/favicon.ico" type="image/x-icon">

  <style>
    .episode-item.active {
      background-color: var(--primary-color, #ef4444);
      color: white;
      font-weight: bold;
      border-radius: 5px;
    }

    #sandbox-toggle {
      margin: 10px auto;
      padding: 10px 20px;
      display: block;
      background-color: #4b5563;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    #warning-message {
      color: red;
      font-weight: bold;
      text-align: center;
      display: none;
    }

    /* âœ… Ù…ÙŠÙ†ÙŠ Ø¨Ù„Ø§ÙŠØ± */
    .mini-player {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 320px;
      height: 180px;
      background: #000;
      border: 2px solid #333;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 15px rgba(0,0,0,0.4);
      z-index: 9999;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    .mini-player.hidden {
      opacity: 0;
      pointer-events: none;
      transform: scale(0.8);
    }

    /* âœ… Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« */
    #search-box {
      width: 90%;
      padding: 8px 10px;
      margin: 10px auto;
      display: block;
      border-radius: 8px;
      border: 1px solid #555;
      background-color: #1f2937;
      color: white;
      font-size: 14px;
    }
  </style>
</head>

<body>
  <div id="navbar-container"></div>

  <div class="container">
    <main class="main-content">
      <div class="anime-info-header">
        <h2 id="anime-title">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>
        <p id="episode-title">Ø±Ù‚Ù… Ø§Ù„Ø­Ù„Ù‚Ø©: ...</p>
      </div>

      <div class="server-buttons" id="server-buttons-container"></div>

      <!-- Ø²Ø± ØªØ¹Ø·ÙŠÙ„ Ù…Ø§Ù†Ø¹ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª -->
      <button id="sandbox-toggle">ØªØ´ØºÙŠÙ„ ÙˆØ¶Ø¹ Ù…Ø§Ù†Ø¹ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</button>
      <p id="warning-message">âš ï¸ Ø¨Ø¹Ø¶ Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª Ù‚Ø¯ Ù„Ø§ ØªØ¹Ù…Ù„ Ø¹Ù†Ø¯ ØªØ´ØºÙŠÙ„ Ù…Ø§Ù†Ø¹ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª.</p>

      <div class="video-container" id="video-container">
        <iframe id="video-player" src="" frameborder="0" allowfullscreen></iframe>
      </div>

      <div class="navigation-buttons">
        <button id="prev-btn">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
        <button id="next-btn">Ø§Ù„ØªØ§Ù„ÙŠ</button>
      </div>
    </main>

    <aside class="episodes">
      <h2>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù„Ù‚Ø§Øª</h2>
      <!-- âœ… Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« -->
      <input type="text" id="search-box" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø­Ù„Ù‚Ø©...">
      <ul id="episodes-list"></ul>
    </aside>
  </div>

  <script>
    let episodes = [];
    let currentEpisodeIndex = 0;
    let currentServerName = '';

    const episodesList = document.getElementById('episodes-list');
    const videoPlayer = document.getElementById('video-player');
    const videoContainer = document.getElementById('video-container');
    const animeTitle = document.getElementById('anime-title');
    const episodeTitle = document.getElementById('episode-title');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const serverButtonsContainer = document.getElementById('server-buttons-container');
    const sandboxToggle = document.getElementById('sandbox-toggle');
    const warningMessage = document.getElementById('warning-message');
    const searchBox = document.getElementById('search-box');

    let sandboxEnabled = localStorage.getItem("sandbox") !== "false";

    function applySandbox() {
      if (sandboxEnabled) {
        videoPlayer.setAttribute("sandbox", "allow-scripts allow-same-origin");
        sandboxToggle.textContent = "ØªØ¹Ø·ÙŠÙ„ ÙˆØ¶Ø¹ Ù…Ø§Ù†Ø¹ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª";
        warningMessage.style.display = "block";
      } else {
        videoPlayer.removeAttribute("sandbox");
        sandboxToggle.textContent = "ØªØ´ØºÙŠÙ„ ÙˆØ¶Ø¹ Ù…Ø§Ù†Ø¹ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª";
        warningMessage.style.display = "none";
      }
    }

    sandboxToggle.addEventListener("click", () => {
      sandboxEnabled = !sandboxEnabled;
      localStorage.setItem("sandbox", sandboxEnabled);
      applySandbox();
      updatePlayer();
    });

    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    function setEpisodeFromURL() {
      const episodeParam = getQueryParam('episode');
      if (episodeParam) {
        const episodeIndex = parseInt(episodeParam, 10) - 1;
        if (episodeIndex >= 0 && episodeIndex < episodes.length) {
          playEpisode(episodeIndex);
        }
      }
    }

    function loadEpisodesData() {
      const animeId = getQueryParam('id');
      if (!animeId) {
        document.body.innerHTML = '<h1>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø£Ù†Ù…ÙŠ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·</h1>';
        return;
      }

      fetch(`episodes/${animeId}.json`)
        .then(response => response.json())
        .then(data => {
          episodes = data.episodes;
          animeTitle.textContent = data.animeTitle || "Ø£Ù†Ù…ÙŠ";
          const metaDescription = document.querySelector('meta[name="description"]');
          if (metaDescription) metaDescription.setAttribute('content', `Ù…Ø´Ø§Ù‡Ø¯Ø© Ø­Ù„Ù‚Ø§Øª ${data.animeTitle}`);
          loadEpisodes();
          setEpisodeFromURL();
        })
        .catch(err => {
          console.error("Ø®Ø·Ø£:", err);
          document.body.innerHTML = "<h1>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h1>";
        });
    }

    function loadEpisodes() {
      episodesList.innerHTML = '';
      const currentEpisodeNumber = parseInt(getQueryParam('episode'), 10);

      episodes.forEach((episode) => {
        const li = document.createElement('li');
        li.className = 'episode-item';
        if (episode.number === currentEpisodeNumber) li.classList.add('active');
        li.textContent = episode.title;

        li.addEventListener('click', () => {
          const newUrl = `?id=${getQueryParam('id')}&episode=${episode.number}`;
          history.pushState({}, '', newUrl);
          playEpisode(episode.number - 1);
          loadEpisodes();
        });

        episodesList.appendChild(li);
      });
    }

    function loadServerButtons() {
      serverButtonsContainer.innerHTML = '';
      const currentEpisode = episodes[currentEpisodeIndex];
      currentEpisode.servers.forEach(server => {
        const button = document.createElement('button');
        button.textContent = server.serverName;
        button.classList.add('server-button');
        if (server.serverName === currentServerName) button.classList.add('active');
        button.addEventListener('click', () => {
          currentServerName = server.serverName;
          updatePlayer();
        });
        serverButtonsContainer.appendChild(button);
      });
    }

    function updatePlayer() {
      const currentEpisode = episodes[currentEpisodeIndex];
      episodeTitle.textContent = `Ø±Ù‚Ù… Ø§Ù„Ø­Ù„Ù‚Ø©: ${currentEpisode.number}`;
      document.title = `${animeTitle.textContent} - Ø§Ù„Ø­Ù„Ù‚Ø© ${currentEpisode.number}`;
      if (!currentServerName && currentEpisode.servers.length > 0)
        currentServerName = currentEpisode.servers[0].serverName;

      const currentServer = currentEpisode.servers.find(s => s.serverName === currentServerName);
      if (currentServer) videoPlayer.src = currentServer.url;
      applySandbox();
      loadServerButtons();
    }

    function playEpisode(index) {
      currentEpisodeIndex = index;
      currentServerName = '';
      updatePlayer();
    }

    function navigateEpisode(direction) {
      currentEpisodeIndex += direction;
      if (currentEpisodeIndex < 0) currentEpisodeIndex = 0;
      if (currentEpisodeIndex >= episodes.length) currentEpisodeIndex = episodes.length - 1;
      currentServerName = '';
      const newUrl = `?id=${getQueryParam('id')}&episode=${episodes[currentEpisodeIndex].number}`;
      history.pushState({}, '', newUrl);
      updatePlayer();
      loadEpisodes();
    }

    prevBtn.addEventListener('click', () => navigateEpisode(-1));
    nextBtn.addEventListener('click', () => navigateEpisode(1));

    window.addEventListener('popstate', () => {
      setEpisodeFromURL();
      loadEpisodes();
    });

    /* âœ… Ù…ÙŠÙ†ÙŠ Ø¨Ù„Ø§ÙŠØ± */
    const miniPlayer = videoContainer.cloneNode(true);
    miniPlayer.classList.add('mini-player', 'hidden');
    document.body.appendChild(miniPlayer);

    window.addEventListener('scroll', () => {
      const rect = videoContainer.getBoundingClientRect();
      if (rect.bottom < 0) {
        miniPlayer.classList.remove('hidden');
      } else {
        miniPlayer.classList.add('hidden');
      }
    });

    /* âœ… Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ù„Ù‚Ø§Øª */
    searchBox.addEventListener('input', () => {
      const term = searchBox.value.toLowerCase();
      const items = episodesList.querySelectorAll('.episode-item');
      items.forEach(li => {
        li.style.display = li.textContent.toLowerCase().includes(term) ? '' : 'none';
      });
    });

    window.onload = () => {
      applySandbox();
      loadEpisodesData();
    };
  </script>

  <script>
    fetch('../navbar.html')
      .then(r => r.text())
      .then(d => document.getElementById('navbar-container').innerHTML = d);
  </script>

  <div style="margin: 15px 0; text-align: center;">
    <script async data-cfasync="false" src="//pl27400501.profitableratecpm.com/cccf85ebe49cd5752952d5b413cfb457/invoke.js"></script>
    <div id="container-cccf85ebe49cd5752952d5b413cfb457"></div>
  </div>

</body>
</html>
