<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø­Ù„Ù‚Ø©</title>
  <meta name="description" content="Ø¹Ø±Ø¶ Ø£Ù†Ù…ÙŠ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ" id="meta-description">
  <link rel="stylesheet" href="../CSS/episodes.css">
  <link rel="stylesheet" href="../CSS/style.css">
  <link rel="icon" href="https://abdo838.github.io/1/navbar/favicon.ico" type="image/x-icon">

  <style>
    .episode-item.active {
      background-color: var(--primary-color, #ef4444);
      color: white;
      font-weight: bold;
      border-radius: 5px;
    }
    .episode-item.watched::after {
      content: "âœ”ï¸";
      color: #16a34a;
      margin-left: 8px;
      font-size: 1.1em;
    }
    #sandbox-toggle {
      margin: 10px auto;
      padding: 10px 20px;
      display: block;
      background-color: #4b5563;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #warning-message {
      color: red;
      font-weight: bold;
      text-align: center;
      display: none;
    }
  </style>
</head>

<body>
  <div id="navbar-container"></div>

  <div class="container">
    <main class="main-content">
      <div class="anime-info-header">
        <h2 id="anime-title">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>
        <p id="episode-title">Ø±Ù‚Ù… Ø§Ù„Ø­Ù„Ù‚Ø©: ...</p>
      </div>

      <div class="server-buttons" id="server-buttons-container"></div>
      <button id="sandbox-toggle">ØªØ´ØºÙŠÙ„ ÙˆØ¶Ø¹ Ù…Ø§Ù†Ø¹ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</button>
      <p id="warning-message">âš ï¸ Ø¨Ø¹Ø¶ Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª Ù‚Ø¯ Ù„Ø§ ØªØ¹Ù…Ù„ Ø¹Ù†Ø¯ ØªØ´ØºÙŠÙ„ Ù…Ø§Ù†Ø¹ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª.</p>

      <div class="video-container">
        <iframe id="video-player" src="" frameborder="0" allowfullscreen></iframe>
      </div>

      <div class="navigation-buttons">
        <button id="prev-btn">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
        <button id="next-btn">Ø§Ù„ØªØ§Ù„ÙŠ</button>
      </div>
    </main>

    <aside class="episodes">
      <h2>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù„Ù‚Ø§Øª</h2>
      <ul id="episodes-list"></ul>
    </aside>
  </div>

  <script>
    let episodes = [];
    let currentEpisodeIndex = 0;
    let currentServerName = "";
    let sandboxEnabled = localStorage.getItem("sandbox") !== "false";
    let RSLoaded = false;

    const episodesList = document.getElementById("episodes-list");
    const videoPlayer   = document.getElementById("video-player");
    const animeTitle    = document.getElementById("anime-title");
    const episodeTitle  = document.getElementById("episode-title");
    const prevBtn       = document.getElementById("prev-btn");
    const nextBtn       = document.getElementById("next-btn");
    const serverButtons = document.getElementById("server-buttons-container");
    const sandboxToggle = document.getElementById("sandbox-toggle");
    const warningMessage = document.getElementById("warning-message");

    // ============================
    // ğŸ”¹ ØªØ­Ù…ÙŠÙ„ RS.js Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    // ============================
    videoPlayer.addEventListener("click", () => {
      if (RSLoaded) return;
      const script = document.createElement("script");
      script.type = "module";
      script.src = "/RS.js";
      document.body.appendChild(script);
      RSLoaded = true;
    });

    // ============================
    // ğŸ”¹ ÙˆØ¶Ø¹ sandbox
    // ============================
    function applySandbox() {
      if (sandboxEnabled) {
        videoPlayer.setAttribute("sandbox", "allow-scripts allow-same-origin");
        sandboxToggle.textContent = "ØªØ¹Ø·ÙŠÙ„ ÙˆØ¶Ø¹ Ù…Ø§Ù†Ø¹ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª";
        warningMessage.style.display = "block";
      } else {
        videoPlayer.removeAttribute("sandbox");
        sandboxToggle.textContent = "ØªØ´ØºÙŠÙ„ ÙˆØ¶Ø¹ Ù…Ø§Ù†Ø¹ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª";
        warningMessage.style.display = "none";
      }
    }

    sandboxToggle.addEventListener("click", () => {
      sandboxEnabled = !sandboxEnabled;
      localStorage.setItem("sandbox", sandboxEnabled);
      applySandbox();
      updatePlayer();
    });

    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    // ============================
    // ğŸ”¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ù„Ù‚Ø© Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    // ============================
    function setEpisodeFromURL() {
      let ep = getQueryParam("episode");
      if (!ep || ep === "None" || ep === "null") {
        playEpisode(0);
        return;
      }
      if (isNaN(ep)) {
        playEpisode(0);
        return;
      }
      ep = parseInt(ep, 10);
      const index = episodes.findIndex(e => e.number == ep);
      if (index !== -1) playEpisode(index);
      else playEpisode(0);
    }

    // ============================
    // ğŸ”¹ ØªØ­Ù…ÙŠÙ„ JSON
    // ============================
    function loadEpisodesData() {
      const animeId = getQueryParam("id");
      if (!animeId) return;

      fetch(`episodes/${animeId}.json`)
        .then(res => res.json())
        .then(data => {
          episodes = data.episodes;
          episodes.sort((a,b) => a.number - b.number);

          if (data.animeTitle) {
            animeTitle.textContent = data.animeTitle;
            const metaDescription = document.querySelector('meta[name="description"]');
            if(metaDescription) metaDescription.setAttribute('content', `Ù…Ø´Ø§Ù‡Ø¯Ø© Ø­Ù„Ù‚Ø§Øª ${data.animeTitle}`);
          }

          setEpisodeFromURL();
          loadEpisodes();
        })
        .catch(err => {
          console.error(err);
          document.body.innerHTML = "<h1>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ù„Ù‚Ø§Øª</h1>";
        });
    }

    // ============================
    // ğŸ”¹ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ù„Ù‚Ø§Øª
    // ============================
    function loadEpisodes() {
      episodesList.innerHTML = "";
      episodes.forEach((episode,index) => {
        const li = document.createElement("li");
        li.className = "episode-item";
        li.textContent = episode.title;

        if (index === currentEpisodeIndex) li.classList.add("active");

        li.addEventListener("click", () => {
          const newUrl = `?id=${getQueryParam("id")}&episode=${episode.number}`;
          history.pushState({}, "", newUrl);
          playEpisode(index);
        });

        episodesList.appendChild(li);
      });
    }

    // ============================
    // ğŸ”¹ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø­Ù„Ù‚Ø©
    // ============================
    function playEpisode(index) {
      currentEpisodeIndex = index;
      const ep = episodes[index];
      episodeTitle.textContent = `Ø±Ù‚Ù… Ø§Ù„Ø­Ù„Ù‚Ø©: ${ep.number}`;
      document.title = `${animeTitle.textContent} - Ø§Ù„Ø­Ù„Ù‚Ø© ${ep.number}`;
      currentServerName = ep.servers[0].serverName;
      videoPlayer.src = ep.servers[0].url;

      loadServerButtons();
      loadEpisodes();
    }

    // ============================
    // ğŸ”¹ Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª
    // ============================
    function loadServerButtons() {
      serverButtons.innerHTML = "";
      const ep = episodes[currentEpisodeIndex];
      ep.servers.forEach(server => {
        const btn = document.createElement("button");
        btn.textContent = server.serverName;
        if (server.serverName === currentServerName) btn.classList.add("active");

        btn.onclick = () => {
          currentServerName = server.serverName;
          videoPlayer.src = server.url;
          loadServerButtons();
        };
        serverButtons.appendChild(btn);
      });
    }

    // ============================
    // ğŸ”¹ Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø­Ù„Ù‚Ø§Øª
    // ============================
    function navigateEpisode(direction) {
      currentEpisodeIndex += direction;
      if(currentEpisodeIndex < 0) currentEpisodeIndex = 0;
      if(currentEpisodeIndex >= episodes.length) currentEpisodeIndex = episodes.length-1;
      const newUrl = `?id=${getQueryParam("id")}&episode=${episodes[currentEpisodeIndex].number}`;
      history.pushState({}, "", newUrl);
      playEpisode(currentEpisodeIndex);
    }

    prevBtn.onclick = () => navigateEpisode(-1);
    nextBtn.onclick = () => navigateEpisode(1);
    window.onpopstate = () => { setEpisodeFromURL(); loadEpisodes(); }

    window.onload = () => { applySandbox(); loadEpisodesData(); }
  </script>

  <script>
    fetch('../navbar.html')
      .then(res => res.text())
      .then(data => document.getElementById('navbar-container').innerHTML = data);
  </script>

</body>
</html>
